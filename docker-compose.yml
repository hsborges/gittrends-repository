version: '3.7'

services:
  mongo:
    image: mongo:latest
    container_name: mongo
    restart: always
    command: --wiredTigerCacheSizeGB 1 --wiredTigerJournalCompressor zstd --directoryperdb --auth
    ports:
      - ${GITTRENDS_DATABASE_PORT}:27017
    volumes:
      - db:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${GITTRENDS_DATABASE_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${GITTRENDS_DATABASE_PASSWORD}
      MONGO_INITDB_DATABASE: ${GITTRENDS_DATABASE_DB}

  redis:
    image: redis:alpine
    container_name: redis
    restart: always
    ports:
      - ${GITTRENDS_REDIS_PORT}:6379
    command: --maxmemory 100mb --maxmemory-policy allkeys-lru

  proxy-server:
    image: node:alpine
    container_name: gittrends-proxy-server
    entrypoint: npx @hsborges/github-proxy-server --tokens tokens.txt --request-interval 250
    restart: unless-stopped
    volumes:
      - ./data/tokens.dev.txt:/tokens.txt:ro
    ports:
      - 3000:3000
    environment:
      PORT: 3000

  queue-board:
    extends:
      file: docker-compose.service.yml
      service: service
    container_name: gittrends-service-queue-board
    restart: unless-stopped
    command: yarn queue-board
    ports:
      - ${GITTRENDS_QUEUE_BOARD_PORT}:${GITTRENDS_QUEUE_BOARD_PORT}
    depends_on:
      - redis

  scheduler:
    extends:
      file: docker-compose.service.yml
      service: service
    container_name: gittrends-service-scheduler
    command: yarn schedule all --wait 168
    depends_on:
      - mongo
      - redis

  updater:
    extends:
      file: docker-compose.service.yml
      service: service
    container_name: gittrends-service-updater
    restart: unless-stopped
    command: yarn update --type repositories --workers 1
    depends_on:
      - mongo
      - redis
      - proxy-server

  users-updater:
    extends:
      file: docker-compose.service.yml
      service: service
    container_name: gittrends-service-users-updater
    restart: unless-stopped
    command: yarn update --type users --workers 1
    depends_on:
      - mongo
      - redis
      - proxy-server

volumes:
  db:
    name: gittrends.app
